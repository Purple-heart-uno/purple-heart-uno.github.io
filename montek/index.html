<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∏–Ω–æ–º–∞–Ω - —É–≥–∞–¥–∞–π —Ñ–∏–ª—å–º</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        class FilmAkinator {
            constructor() {
                this.database = [];
                this.attributes = new Set();
                this.current_answers = {};
                this.possible_answers = {
                    "–¥–∞": 1, "—Å–∫–æ—Ä–µ–µ –¥–∞": 0.7, "–Ω–µ –∑–Ω–∞—é": 0, 
                    "—Å–∫–æ—Ä–µ–µ –Ω–µ—Ç": -0.7, "–Ω–µ—Ç": -1
                };
                this.isLoading = true;
                this.init();
            }
            
            async init() {
                await this.loadDatabase();
                this.isLoading = false;
            }
            
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
            
            attribute_to_numeric(film, attribute) {
                const value = film.attributes[attribute];
                return value ? 1 : -1;
            }
            
            calculate_information_gain(attribute) {
                if (!this.database.length) return 0;
                
                const values = this.database.map(film => 
                    this.attribute_to_numeric(film, attribute)
                );
                
                if (new Set(values).size === 1) return 0;
                
                const counts = {};
                values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                
                let entropy = 0;
                const total = values.length;
                
                for (const count of Object.values(counts)) {
                    const p = count / total;
                    if (p > 0) {
                        entropy -= p * Math.log2(p);
                    }
                }
                
                return entropy;
            }
            
            choose_best_question() {
                if (!this.database.length) {
                    console.log('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞');
                    return null;
                }
                
                const attributes = this.get_all_attributes();
                let best_attribute = null;
                let best_gain = -1;
                
                for (const attribute of attributes) {
                    if (!this.current_answers.hasOwnProperty(attribute)) {
                        const gain = this.calculate_information_gain(attribute);
                        if (gain > best_gain) {
                            best_gain = gain;
                            best_attribute = attribute;
                        }
                    }
                }
                
                console.log('–í—ã–±—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å:', best_attribute, '—Å gain:', best_gain);
                return best_attribute;
            }
            
            filter_films() {
                if (!this.database.length) return [];
                
                const scoredFilms = this.database.map(film => {
                    let match_score = 0;
                    let total_weight = 0;
                    let answered_attributes = 0;
                    
                    for (const [attribute, user_answer] of Object.entries(this.current_answers)) {
                        answered_attributes++;
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–≤–µ—Ç—ã "–Ω–µ –∑–Ω–∞—é"
                        if (user_answer === 0) continue;
                        
                        if (film.attributes.hasOwnProperty(attribute)) {
                            const film_value = this.attribute_to_numeric(film, attribute);
                            
                            // –ë–æ–ª–µ–µ –º—è–≥–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º "—Å–∫–æ—Ä–µ–µ –¥–∞/–Ω–µ—Ç"
                            let similarity = 0;
                            if (user_answer > 0 && film_value > 0) {
                                similarity = 0.8 + (user_answer * 0.2); // 0.8-1.0 –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ "–¥–∞"
                            } else if (user_answer < 0 && film_value < 0) {
                                similarity = 0.8 + (Math.abs(user_answer) * 0.2); // 0.8-1.0 –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ "–Ω–µ—Ç"
                            } else if (user_answer !== 0) {
                                // –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                                similarity = 0.3 - Math.abs(user_answer - film_value) / 4;
                            }
                            
                            match_score += similarity;
                            total_weight += 1;
                        } else if (user_answer > 0) {
                            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–¥–∞", –Ω–æ —É —Ñ–∏–ª—å–º–∞ –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ - —à—Ç—Ä–∞—Ñ
                            match_score -= 0.5 * user_answer;
                            total_weight += 0.5;
                        } else if (user_answer < 0) {
                            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ—Ç", –Ω–æ —É —Ñ–∏–ª—å–º–∞ –µ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç - —à—Ç—Ä–∞—Ñ
                            match_score += 0.5 * user_answer;
                            total_weight += 0.5;
                        }
                    }
                    
                    // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
                    const answer_ratio = answered_attributes > 0 ? Object.keys(this.current_answers).length / answered_attributes : 1;
                    
                    const final_score = total_weight > 0 ? 
                        (match_score / total_weight) * answer_ratio : 
                        0.5; // –ë–∞–∑–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è —Ñ–∏–ª—å–º–æ–≤ –±–µ–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                    
                    return {
                        ...film,
                        match_score: Math.max(0, Math.min(1, final_score)) // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 0-1
                    };
                });
                
                return scoredFilms.sort((a, b) => b.match_score - a.match_score);
            }
            
            getTopCandidates(limit = 5) {
                const candidates = this.filter_films();
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –¥–∞–∂–µ —Å –Ω–∏–∑–∫–∏–º score, –Ω–æ –Ω–µ –Ω–∏–∂–µ 0.1
                return candidates.filter(film => film.match_score >= 0.1).slice(0, limit);
            }
            
            shouldMakeGuess() {
                const candidates = this.filter_films();
                if (candidates.length === 0) return false;
                
                const bestCandidate = candidates[0];
                const answeredQuestions = Object.keys(this.current_answers).length;
                
                // –î–µ–ª–∞–µ–º –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏:
                // 1. –ï—Å—Ç—å —è–≤–Ω—ã–π –ª–∏–¥–µ—Ä —Å –≤—ã—Å–æ–∫–∏–º score
                // 2. –ò–ª–∏ –∑–∞–¥–∞–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤
                // 3. –ò–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                
                if (bestCandidate.match_score > 0.85) return true;
                if (answeredQuestions >= 12) return true;
                if (candidates.length <= 2 && answeredQuestions >= 5) return true;
                
                return false;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let akinator = new FilmAkinator();
        let currentQuestion = null;
        let selectedAttributes = new Set();
        let questionsCount = 0;

        // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã
        async function waitForDatabase() {
            while (akinator.isLoading) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        async function showSection(sectionId) {
            await waitForDatabase();
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            if (sectionId === 'database') {
                displayFilmsList();
            } else if (sectionId === 'admin') {
                renderAttributesGrid();
                updateStats();
            }
        }

        function startGame() {
            akinator.current_answers = {};
            questionsCount = 0;
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('answers').style.display = 'grid';
            document.getElementById('result').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            showQuestion();
        }

        function showQuestion() {
            currentQuestion = akinator.choose_best_question();
            
            if (!currentQuestion) {
                endGame();
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞—Ç—Ä–∏–±—É—Ç –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–æ–ø—Ä–æ—Å
            let questionText = currentQuestion;
            if (questionText.includes('_')) {
                const parts = questionText.split('_');
                const mainPart = parts[0];
                const valuePart = parts.slice(1).join(' ');
                
                switch(mainPart) {
                    case '—Å—Ç—Ä–∞–Ω–∞':
                        questionText = `–§–∏–ª—å–º —Å–Ω—è—Ç –≤ ${valuePart}?`;
                        break;
                    case '–≥–æ–¥':
                        questionText = `–§–∏–ª—å–º –≤—ã—à–µ–ª –≤ ${valuePart} –≥–æ–¥—É?`;
                        break;
                    case '–∂–∞–Ω—Ä':
                        questionText = `–≠—Ç–æ —Ñ–∏–ª—å–º –≤ –∂–∞–Ω—Ä–µ ${valuePart}?`;
                        break;
                    case '—Ä–µ–∂–∏—Å—Å–µ—Ä':
                        questionText = `–§–∏–ª—å–º —Å–Ω—è–ª ${valuePart}?`;
                        break;
                    case '–∞–∫—Ç–µ—Ä':
                        questionText = `–í –≥–ª–∞–≤–Ω–æ–π —Ä–æ–ª–∏ ${valuePart}?`;
                        break;
                    case '–∫–æ–º–ø–∞–Ω–∏—è':
                        questionText = `–§–∏–ª—å–º –≤—ã–ø—É—Å—Ç–∏–ª–∞ –∫–æ–º–ø–∞–Ω–∏—è ${valuePart}?`;
                        break;
                    default:
                        questionText = `–§–∏–ª—å–º —Å–≤—è–∑–∞–Ω —Å "${questionText.replace(/_/g, ' ')}"?`;
                }
            } else {
                questionText = `–§–∏–ª—å–º —Å–≤—è–∑–∞–Ω —Å "${questionText}"?`;
            }
            
            document.getElementById('questionText').textContent = questionText;
            console.log('–ó–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å:', currentQuestion, '–û—Ç–≤–µ—Ç–æ–≤:', Object.keys(akinator.current_answers).length);
        }

        function answerQuestion(answer) {
            if (!currentQuestion) return;
            
            questionsCount++;
            const progress = Math.min((questionsCount / 20) * 100, 100);
            document.getElementById('progressBar').style.width = progress + '%';
            
            akinator.current_answers[currentQuestion] = akinator.possible_answers[answer];
            console.log('–û—Ç–≤–µ—Ç:', answer, '–Ω–∞ –≤–æ–ø—Ä–æ—Å:', currentQuestion);
            console.log('–í—Å–µ –æ—Ç–≤–µ—Ç—ã:', akinator.current_answers);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            if (akinator.shouldMakeGuess()) {
                const candidates = akinator.filter_films();
                const bestCandidate = candidates[0];
                
                if (bestCandidate && bestCandidate.match_score > 0.6) {
                    showGuess(bestCandidate.title);
                } else {
                    showFilmOptions(candidates);
                }
            } else if (questionsCount >= 20) {
                // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
                const candidates = akinator.filter_films();
                showFilmOptions(candidates);
            } else {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
                showQuestion();
            }
        }

        function showGuess(filmTitle) {
            document.getElementById('guessResult').innerHTML = 
                `<h3>üéâ –Ø –¥—É–º–∞—é, —ç—Ç–æ: ${filmTitle}</h3>
                 <p>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ${Math.round(akinator.filter_films()[0].match_score * 100)}%</p>`;
            document.getElementById('guessButtons').style.display = 'block';
            document.getElementById('filmOptions').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
        }

        function showFilmOptions(candidates) {
            const topCandidates = akinator.getTopCandidates();
            
            if (topCandidates.length === 0) {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>üòî –ù–µ –º–æ–≥—É —É–≥–∞–¥–∞—Ç—å —Ñ–∏–ª—å–º. –í–æ–∑–º–æ–∂–Ω–æ, –µ–≥–æ –Ω–µ—Ç –≤ –±–∞–∑–µ –∏–ª–∏ –æ—Ç–≤–µ—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã.</h3>';
                document.getElementById('filmOptions').style.display = 'none';
                document.getElementById('guessButtons').style.display = 'none';
            } else {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>üìã –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</h3>';
                
                const filmList = document.getElementById('filmList');
                filmList.innerHTML = '';
                
                topCandidates.forEach(film => {
                    const li = document.createElement('li');
                    li.className = 'film-item';
                    li.innerHTML = `
                        <strong>${film.title}</strong>
                        <br><small>–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${Math.round(film.match_score * 100)}%</small>
                    `;
                    li.onclick = () => confirmFilmGuess(film.title);
                    filmList.appendChild(li);
                });
                
                document.getElementById('filmOptions').style.display = 'block';
                document.getElementById('guessButtons').style.display = 'none';
            }
            
            document.getElementById('result').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
        }

        function confirmFilmGuess(filmTitle) {
            document.getElementById('guessResult').innerHTML = 
                `<h3>üéâ –û—Ç–ª–∏—á–Ω–æ! –≠—Ç–æ ${filmTitle}</h3>`;
            document.getElementById('filmOptions').style.display = 'none';
            
            setTimeout(() => {
                if (confirm('–•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑?')) {
                    startGame();
                }
            }, 1000);
        }

        function continueGame() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('answers').style.display = 'grid';
            showQuestion();
        }

        function confirmGuess(isCorrect) {
            if (isCorrect) {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>üéâ –£—Ä–∞! –Ø —É–≥–∞–¥–∞–ª!</h3>';
                setTimeout(() => {
                    if (confirm('–•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑?')) {
                        startGame();
                    }
                }, 1000);
            } else {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>üòî –ù–µ —É–≥–∞–¥–∞–ª. –î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ!</h3>';
                setTimeout(() => {
                    continueGame();
                }, 1500);
            }
        }

        function endGame() {
            document.getElementById('questionText').textContent = '–ù–µ –º–æ–≥—É —É–≥–∞–¥–∞—Ç—å —Ñ–∏–ª—å–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ñ–∏–ª—å–º–æ–≤ –≤ –±–∞–∑—É!';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('gameControls').style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        function resetGame() {
            akinator.current_answers = {};
            document.getElementById('gameControls').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('questionText').textContent = '–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É? –ó–∞–≥–∞–¥–∞–π—Ç–µ —Ñ–∏–ª—å–º, –∞ —è –ø–æ–ø—Ä–æ–±—É—é —É–≥–∞–¥–∞—Ç—å –µ–≥–æ!';
        }

        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById('loadingAttributes').style.display = 'block';
            document.getElementById('attributesGrid').style.display = 'none';
            document.getElementById('loadingFilms').style.display = 'block';
            document.getElementById('filmsList').style.display = 'none';
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã
            await waitForDatabase();
            
            console.log('–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å');
            updateStats();
            renderAttributesGrid();
            displayFilmsList();
            
            // –°–∫—Ä—ã–≤–∞–µ–º loading —Å–æ—Å—Ç–æ—è–Ω–∏—è
            document.getElementById('loadingAttributes').style.display = 'none';
            document.getElementById('attributesGrid').style.display = 'grid';
        });
    </script>
</body>
</html>
