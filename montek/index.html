<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Киноман - угадай фильм</title>
    <style>
        /* Стили остаются без изменений */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML структура остается без изменений -->
    </div>

    <script>
        // Основной класс приложения
        class FilmAkinator {
            constructor() {
                this.database = [];
                this.attributes = new Set();
                this.current_answers = {};
                this.possible_answers = {
                    "да": 1, "скорее да": 0.7, "не знаю": 0, 
                    "скорее нет": -0.7, "нет": -1
                };
                this.isLoading = true;
                this.init();
            }
            
            async init() {
                await this.loadDatabase();
                this.isLoading = false;
            }
            
            // ... остальные методы загрузки базы без изменений ...
            
            attribute_to_numeric(film, attribute) {
                const value = film.attributes[attribute];
                return value ? 1 : -1;
            }
            
            calculate_information_gain(attribute) {
                if (!this.database.length) return 0;
                
                const values = this.database.map(film => 
                    this.attribute_to_numeric(film, attribute)
                );
                
                if (new Set(values).size === 1) return 0;
                
                const counts = {};
                values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                
                let entropy = 0;
                const total = values.length;
                
                for (const count of Object.values(counts)) {
                    const p = count / total;
                    if (p > 0) {
                        entropy -= p * Math.log2(p);
                    }
                }
                
                return entropy;
            }
            
            choose_best_question() {
                if (!this.database.length) {
                    console.log('База данных пуста');
                    return null;
                }
                
                const attributes = this.get_all_attributes();
                let best_attribute = null;
                let best_gain = -1;
                
                for (const attribute of attributes) {
                    if (!this.current_answers.hasOwnProperty(attribute)) {
                        const gain = this.calculate_information_gain(attribute);
                        if (gain > best_gain) {
                            best_gain = gain;
                            best_attribute = attribute;
                        }
                    }
                }
                
                console.log('Выбран вопрос:', best_attribute, 'с gain:', best_gain);
                return best_attribute;
            }
            
            filter_films() {
                if (!this.database.length) return [];
                
                const scoredFilms = this.database.map(film => {
                    let match_score = 0;
                    let total_weight = 0;
                    let answered_attributes = 0;
                    
                    for (const [attribute, user_answer] of Object.entries(this.current_answers)) {
                        answered_attributes++;
                        
                        // Пропускаем ответы "не знаю"
                        if (user_answer === 0) continue;
                        
                        if (film.attributes.hasOwnProperty(attribute)) {
                            const film_value = this.attribute_to_numeric(film, attribute);
                            
                            // Более мягкое сравнение с учетом "скорее да/нет"
                            let similarity = 0;
                            if (user_answer > 0 && film_value > 0) {
                                similarity = 0.8 + (user_answer * 0.2); // 0.8-1.0 за совпадение "да"
                            } else if (user_answer < 0 && film_value < 0) {
                                similarity = 0.8 + (Math.abs(user_answer) * 0.2); // 0.8-1.0 за совпадение "нет"
                            } else if (user_answer !== 0) {
                                // Частичное совпадение для неоднозначных ответов
                                similarity = 0.3 - Math.abs(user_answer - film_value) / 4;
                            }
                            
                            match_score += similarity;
                            total_weight += 1;
                        } else if (user_answer > 0) {
                            // Если пользователь сказал "да", но у фильма нет атрибута - штраф
                            match_score -= 0.5 * user_answer;
                            total_weight += 0.5;
                        } else if (user_answer < 0) {
                            // Если пользователь сказал "нет", но у фильма есть атрибут - штраф
                            match_score += 0.5 * user_answer;
                            total_weight += 0.5;
                        }
                    }
                    
                    // Учитываем количество отвеченных атрибутов
                    const answer_ratio = answered_attributes > 0 ? Object.keys(this.current_answers).length / answered_attributes : 1;
                    
                    const final_score = total_weight > 0 ? 
                        (match_score / total_weight) * answer_ratio : 
                        0.5; // Базовый рейтинг для фильмов без совпадений
                    
                    return {
                        ...film,
                        match_score: Math.max(0, Math.min(1, final_score)) // Ограничиваем 0-1
                    };
                });
                
                return scoredFilms.sort((a, b) => b.match_score - a.match_score);
            }
            
            getTopCandidates(limit = 5) {
                const candidates = this.filter_films();
                // Возвращаем топ кандидатов, даже с низким score, но не ниже 0.1
                return candidates.filter(film => film.match_score >= 0.1).slice(0, limit);
            }
            
            shouldMakeGuess() {
                const candidates = this.filter_films();
                if (candidates.length === 0) return false;
                
                const bestCandidate = candidates[0];
                const answeredQuestions = Object.keys(this.current_answers).length;
                
                // Делаем предположение если:
                // 1. Есть явный лидер с высоким score
                // 2. Или задано достаточно вопросов
                // 3. Или осталось мало кандидатов
                
                if (bestCandidate.match_score > 0.85) return true;
                if (answeredQuestions >= 12) return true;
                if (candidates.length <= 2 && answeredQuestions >= 5) return true;
                
                return false;
            }
        }

        // Глобальные переменные
        let akinator = new FilmAkinator();
        let currentQuestion = null;
        let selectedAttributes = new Set();
        let questionsCount = 0;

        // Ожидание загрузки базы
        async function waitForDatabase() {
            while (akinator.isLoading) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // Функции интерфейса
        async function showSection(sectionId) {
            await waitForDatabase();
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`.tab[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            if (sectionId === 'database') {
                displayFilmsList();
            } else if (sectionId === 'admin') {
                renderAttributesGrid();
                updateStats();
            }
        }

        function startGame() {
            akinator.current_answers = {};
            questionsCount = 0;
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('answers').style.display = 'grid';
            document.getElementById('result').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            showQuestion();
        }

        function showQuestion() {
            currentQuestion = akinator.choose_best_question();
            
            if (!currentQuestion) {
                endGame();
                return;
            }
            
            // Преобразуем атрибут в читаемый вопрос
            let questionText = currentQuestion;
            if (questionText.includes('_')) {
                const parts = questionText.split('_');
                const mainPart = parts[0];
                const valuePart = parts.slice(1).join(' ');
                
                switch(mainPart) {
                    case 'страна':
                        questionText = `Фильм снят в ${valuePart}?`;
                        break;
                    case 'год':
                        questionText = `Фильм вышел в ${valuePart} году?`;
                        break;
                    case 'жанр':
                        questionText = `Это фильм в жанре ${valuePart}?`;
                        break;
                    case 'режиссер':
                        questionText = `Фильм снял ${valuePart}?`;
                        break;
                    case 'актер':
                        questionText = `В главной роли ${valuePart}?`;
                        break;
                    case 'компания':
                        questionText = `Фильм выпустила компания ${valuePart}?`;
                        break;
                    default:
                        questionText = `Фильм связан с "${questionText.replace(/_/g, ' ')}"?`;
                }
            } else {
                questionText = `Фильм связан с "${questionText}"?`;
            }
            
            document.getElementById('questionText').textContent = questionText;
            console.log('Задан вопрос:', currentQuestion, 'Ответов:', Object.keys(akinator.current_answers).length);
        }

        function answerQuestion(answer) {
            if (!currentQuestion) return;
            
            questionsCount++;
            const progress = Math.min((questionsCount / 20) * 100, 100);
            document.getElementById('progressBar').style.width = progress + '%';
            
            akinator.current_answers[currentQuestion] = akinator.possible_answers[answer];
            console.log('Ответ:', answer, 'на вопрос:', currentQuestion);
            console.log('Все ответы:', akinator.current_answers);
            
            // Проверяем, нужно ли делать предположение
            if (akinator.shouldMakeGuess()) {
                const candidates = akinator.filter_films();
                const bestCandidate = candidates[0];
                
                if (bestCandidate && bestCandidate.match_score > 0.6) {
                    showGuess(bestCandidate.title);
                } else {
                    showFilmOptions(candidates);
                }
            } else if (questionsCount >= 20) {
                // Если задано много вопросов, показываем варианты
                const candidates = akinator.filter_films();
                showFilmOptions(candidates);
            } else {
                // Продолжаем задавать вопросы
                showQuestion();
            }
        }

        function showGuess(filmTitle) {
            document.getElementById('guessResult').innerHTML = 
                `<h3>🎉 Я думаю, это: ${filmTitle}</h3>
                 <p>Вероятность: ${Math.round(akinator.filter_films()[0].match_score * 100)}%</p>`;
            document.getElementById('guessButtons').style.display = 'block';
            document.getElementById('filmOptions').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
        }

        function showFilmOptions(candidates) {
            const topCandidates = akinator.getTopCandidates();
            
            if (topCandidates.length === 0) {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>😔 Не могу угадать фильм. Возможно, его нет в базе или ответы противоречивы.</h3>';
                document.getElementById('filmOptions').style.display = 'none';
                document.getElementById('guessButtons').style.display = 'none';
            } else {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>📋 Возможные варианты:</h3>';
                
                const filmList = document.getElementById('filmList');
                filmList.innerHTML = '';
                
                topCandidates.forEach(film => {
                    const li = document.createElement('li');
                    li.className = 'film-item';
                    li.innerHTML = `
                        <strong>${film.title}</strong>
                        <br><small>Совпадение: ${Math.round(film.match_score * 100)}%</small>
                    `;
                    li.onclick = () => confirmFilmGuess(film.title);
                    filmList.appendChild(li);
                });
                
                document.getElementById('filmOptions').style.display = 'block';
                document.getElementById('guessButtons').style.display = 'none';
            }
            
            document.getElementById('result').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
        }

        function confirmFilmGuess(filmTitle) {
            document.getElementById('guessResult').innerHTML = 
                `<h3>🎉 Отлично! Это ${filmTitle}</h3>`;
            document.getElementById('filmOptions').style.display = 'none';
            
            setTimeout(() => {
                if (confirm('Хотите сыграть еще раз?')) {
                    startGame();
                }
            }, 1000);
        }

        function continueGame() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('answers').style.display = 'grid';
            showQuestion();
        }

        function confirmGuess(isCorrect) {
            if (isCorrect) {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>🎉 Ура! Я угадал!</h3>';
                setTimeout(() => {
                    if (confirm('Хотите сыграть еще раз?')) {
                        startGame();
                    }
                }, 1000);
            } else {
                document.getElementById('guessResult').innerHTML = 
                    '<h3>😔 Не угадал. Давайте попробуем еще!</h3>';
                setTimeout(() => {
                    continueGame();
                }, 1500);
            }
        }

        function endGame() {
            document.getElementById('questionText').textContent = 'Не могу угадать фильм. Попробуйте добавить больше фильмов в базу!';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('gameControls').style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        function resetGame() {
            akinator.current_answers = {};
            document.getElementById('gameControls').style.display = 'block';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('questionText').textContent = 'Готовы начать игру? Загадайте фильм, а я попробую угадать его!';
        }

        // ... остальные функции без изменений ...

        // Инициализация
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Приложение инициализируется...');
            
            // Показываем loading состояние
            document.getElementById('loadingAttributes').style.display = 'block';
            document.getElementById('attributesGrid').style.display = 'none';
            document.getElementById('loadingFilms').style.display = 'block';
            document.getElementById('filmsList').style.display = 'none';
            
            // Ждем загрузки базы
            await waitForDatabase();
            
            console.log('База загружена, запускаем интерфейс');
            updateStats();
            renderAttributesGrid();
            displayFilmsList();
            
            // Скрываем loading состояния
            document.getElementById('loadingAttributes').style.display = 'none';
            document.getElementById('attributesGrid').style.display = 'grid';
        });
    </script>
</body>
</html>
